# H264编码
H264的主要目标是：
1. 高的视频压缩比，当初提出的指标是比H.263，MPEG-4【怀疑是原作者的笔误，可能是MJPEG-2】，约为它们的2倍，现在都已基本实现；
2. 良好的网络亲和性，即可适用于各种传输网络。

为此，H.264 的功能分为两层，即视频编码层（VCL）和网络提取层（NAL)。
**VCL 数据即编码处理的输出，它表示被压缩编码后的视频数据序列。**
在VCL 数据传输或存储之前，这些编码的VCL 数据，先被映射或封装进NAL 单元中。

## 1 VCL层
### 1.1 相关概念
#### 1.1.1 帧(Frame)
帧是连续视频中的一个静态图像。
在H.264中，帧可以被分为三种类型：
- I帧:内部编码帧，关键帧
- P帧:前向预测帧;
- B帧:双向预测帧;
I帧是关键帧，它不依赖于其他帧。P帧依赖于之前的I帧或P帧，而B帧则依赖于前面和后面的帧。

## 2 编码流程
### 2.1 简介
#### 2.1.1 P/B帧的编码

##### **P 帧和 B 帧编码的基本流程为：**
1. 进行运动估计，计算采用帧间编码模式的率失真函数(节)值。P帧只参考前面的帧，B 帧可参考后面的帧。
2. 进行帧内预测，选取率失真函数值最小的帧内模式与帧间模式比较，确定采用哪种编码模式。
3. 计算实际值和预测值的差值。
4. 对残差进行变换和量化。
5. 熵编码，如果是帧间编码模式，编码运动矢量

##### **B帧的结构和编码:**

**1. 分割为宏块:**
   - 与I帧和P帧一样，B帧首先被划分为16x16的宏块。

**2. 双向预测:**
- 对于每个宏块，编码器会选择使用前向预测、后向预测，还是双向预测。选择是基于哪种预测可以给出最佳的压缩结果。
- 前向预测是从之前的帧（可以是I帧或P帧）中进行的。后向预测是从后面的帧中进行的。双向预测则结合了前向和后向预测的结果。

**3. 运动估计与运动补偿:**
- B帧的宏块通过运动估计来寻找在参考帧中的最佳匹配，这个过程确定了一个运动矢量。
- 运动补偿使用这个运动矢量来从参考帧中获取预测块。

**4. 变换和量化:**
- 预测和实际宏块之间的差异（称为残差）被转换为频域，这通常是通过使用变换（如DCT）完成的。
- 转换后的数据被量化，减少数据的精度。

**5. 熵编码:**
- 量化后的残差和运动矢量都要经过熵编码，如CABAC或CAVLC。

**6. 组成片:**
- 一组连续的宏块将组成一个片。在B帧中，这些片都是B片。

**7. 封装和传输:**
- 编码完成后，B帧可以被封装在各种容器格式中或直接进行传输。

##### **P帧的结构和编码:**

**1. 分割为宏块:**
- P帧首先被划分为16x16的宏块。

**2. 前向预测:**
- 每个宏块会使用运动估计来从参考帧中找到最佳匹配的块，这会产生一个运动矢量。
- 运动补偿使用这个运动矢量来从参考帧中获取预测块。

**3. 变换和量化:**
与I帧和B帧相似，P帧中每个宏块的残差（即原始数据与预测之间的差异）会被转换为频域，这通常是通过使用变换（如DCT）完成的。
转换后的数据被量化，减少数据的精度。

熵编码:
量化后的残差和运动矢量都要经过熵编码，如CABAC或CAVLC。

组成片:
一组连续的宏块将组成一个片。在P帧中，这些片都是P片。
封装和传输:

编码完成后，P帧可以被封装在各种容器格式中或直接进行传输。
由于P帧只使用了前向预测，它的压缩效率通常低于B帧但高于I帧。尽管P帧的尺寸比I帧小，但它还是需要更多的信息来描述其内容，因为它是基于另一帧的预测。
I 帧编码的基本流程为：
(1) 进行帧内预测，决定所采用的帧内预测模式。
(2) 像素值减去预测值，得到残差。
(3) 对残差进行变换和量化。
(4) 变长编码和算术编码。
(5) 重构图像并滤波，得到的图像作为其它帧的参考帧。
I帧的结构和编码:
分割为宏块:
I帧首先被划分为16x16的宏块。
预测:
尽管I帧是完整的图像数据，但为了压缩，它会对自己进行某种预测。在H.264中，这称为“空间预测”或“帧内预测”。这种预测是基于已经编码的相邻宏块来预测当前宏块的内容。
变换和量化:
宏块的差异（即原始数据与预测之间的差异）会被转换为频域，这通常是通过使用变换（例如DCT）完成的。
转换后的数据被量化，这是一个将高精度值映射到较低精度值的过程，它可以大大减少数据量。
熵编码:

量化后的数据进一步被压缩，通常是使用熵编码技术，如CABAC (Context-Adaptive Binary Arithmetic Coding) 或CAVLC (Context-Adaptive Variable-Length Coding)。
组成片:

一组连续的宏块将组成一个片。在I帧中，这些片都是I片，这意味着它们完全独立于其他帧。
封装和传输:

一旦帧被编码，它可以被封装在容器格式中（如MP4、MKV等）或直接传输。